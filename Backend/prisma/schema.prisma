generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String        @id @default(uuid())
  name         String
  email        String        @unique
  password     String
  proxyUser    ProxyUser? 
  purchases    Purchase[]
  couponUsages CouponUsage[] 
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  cooldown     UserCooldown?
}

model ProxyUser {
  id        Int      @id @default(autoincrement())
  username  String
  password  String
  subuserId String
  user      User     @relation(fields: [userId], references: [id])
  userId    String   @unique
  createdAt DateTime @default(now())
}

enum PurchaseStatus {
  PENDING 
  PAID 
  CANCELED 
  FAILED 
}

model Purchase {
  id          Int            @id @default(autoincrement())
  userId      String
  user        User           @relation(fields: [userId], references: [id])
  gbAmount    Float
  totalPrice  Float
  status      PurchaseStatus @default(PENDING)
  mpPaymentId BigInt? 
  createdAt   DateTime       @default(now())
}

model Coupon {
  id          String        @id @default(uuid())
  code        String        @unique
  discountPct Float 
  onlyOnce    Boolean       @default(false) 
  minGb       Float? 
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  usages      CouponUsage[]

  expiresAt DateTime?
}

model CouponUsage {
  id       Int    @id @default(autoincrement())
  couponId String
  userId   String

  coupon Coupon @relation(fields: [couponId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  usedAt DateTime @default(now())

  @@unique([couponId, userId]) 
}


model UserCooldown {
  id            Int      @id @default(autoincrement())
  userId        String   @unique
  attempts      Int      @default(0)
  cooldownUntil DateTime?

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}
